local root="$1"

if [[ -z "$root" ]] && [[ ! -t 0 ]]; then
  local payload=$(cat)
  local file_path=$(printf '%s' "$payload" | jq -r '.tool_input.file_path // empty')
  [[ -z "$file_path" ]] && return 0
  case "$file_path" in
    */.claude/skills/*|*/.agents/skills/*) ;;
    *) return 0 ;;
  esac
  root=$(git -C "$(dirname "$file_path")" rev-parse --show-toplevel 2>/dev/null) || return 0
fi

root="${root:-.}"
local agents="$root/.agents/skills"
local claude="$root/.claude/skills"

# Codex scenario: .agents/skills is a real dir, migrate to .claude/skills
if [[ -d "$agents" ]] && [[ ! -L "$agents" ]]; then
  mkdir -p "$claude"
  cp -rn "$agents"/* "$claude/" 2>/dev/null
  rm -rf "$agents"
fi

[[ -d "$claude" ]] || return 0

mkdir -p "$root/.agents"
ln -sfn ../.claude/skills "$agents"
